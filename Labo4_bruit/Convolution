import os
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt

# Chemin vers le fichier
dossier_script = os.path.dirname(os.path.abspath(__file__))
fichier_excel = os.path.join(dossier_script, "Values.1mode.xlsx")

# Importer les données
exp = pd.read_excel(fichier_excel, sheet_name=0)
temps = exp["temps"].to_numpy()
signal_mesure = exp["voltage"].to_numpy()

# MÉTHODE PAR CONVOLUTION
# Estimation du bruit de fond par moyenne glissante
window_size = 50  # Ajustez selon la largeur de vos pics
bruit_fond_estime = np.convolve(signal_mesure, np.ones(window_size)/window_size, mode="same")

# Signal corrigé (signal - bruit de fond)
signal_corrige = signal_mesure - bruit_fond_estime
signal_corrige[signal_corrige < 0] = 0  # Supprimer les valeurs négatives

# Séparation entre signal haut et bruit de fond
# On considère que là où signal_corrige > seuil, c'est du "signal haut"
seuil_signal = np.std(signal_corrige) * 2  # ou une autre valeur appropriée

indices_haut = np.where(signal_corrige > seuil_signal)[0]
indices_bas = np.where(signal_corrige <= seuil_signal)[0]

# Extraction des données originales
signal_haut = signal_mesure[indices_haut]
bruit_fond = signal_mesure[indices_bas]

# Calcul des statistiques
mu_haut = np.mean(signal_haut)
sigma_haut = np.std(signal_haut)
mu_bas = np.mean(bruit_fond)
sigma_bas = np.std(bruit_fond)

SNR = mu_haut / sigma_haut

print("="*50)
print("STATISTIQUES")
print("="*50)
print(f"Signal haut - Moyenne: {mu_haut:.4f}, Écart-type: {sigma_haut:.4f}")
print(f"Bruit fond - Moyenne: {mu_bas:.4f}, Écart-type: {sigma_bas:.4f}")
print(f"SNR: {SNR:.2f}")
print(f"Augmentation du signal: {mu_haut - mu_bas:.4f}")
print(f"SEM signal haut: {sigma_haut / np.sqrt(len(signal_haut)):.4f}")

# VISUALISATION
fig, axes = plt.subplots(3, 1, figsize=(14, 10))

# VISUALISATION - Tout dans un seul graphique
plt.figure(figsize=(14, 6))

# Signal original
plt.plot(temps, signal_mesure, 'b-', alpha=0.5, linewidth=1, label='Signal mesuré')

# Bruit de fond estimé
plt.plot(temps, bruit_fond_estime, 'r-', linewidth=2, label='Bruit de fond estimé')

# Signal corrigé (décalé vers le haut pour la visibilité)
plt.plot(temps, signal_corrige, 'g-', alpha=0.7, linewidth=1, label='Signal corrigé')

# Seuil de signal
plt.axhline(seuil_signal, color='purple', linestyle='--', linewidth=1.5, 
            label=f'Seuil: {seuil_signal:.3f}')

# Zone de signal haut
plt.fill_between(temps, 0, signal_corrige, where=(signal_corrige > seuil_signal), 
                 alpha=0.3, color='orange', label='Signal haut')

plt.xlabel('Temps')
plt.ylabel('Voltage')
plt.title('Analyse complète du signal bruité')
plt.legend(loc='best')
plt.grid(True, alpha=0.3)
plt.tight_layout()
plt.show()